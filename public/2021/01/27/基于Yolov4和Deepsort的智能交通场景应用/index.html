<!DOCTYPE html>
<html lang="en">

<!-- Head tag (contains Google-Analytics、Baidu-Tongji)-->
<head>
  <!-- Google Analytics -->
  
    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async="async" src="https://www.googletagmanager.com/gtag/js?id=UA-xxxxxx-xx"></script>
    <script type="text/javascript">
      window.dataLayer = window.dataLayer || [];

      function gtag() {
        dataLayer.push(arguments);
      }
      gtag('js', new Date());

      gtag('config', 'UA-xxxxxx-xx');
    </script>
  

  <!-- Baidu Tongji -->
  
    <script type="text/javascript">
      // Originial
      var _hmt = _hmt || [];
      (function () {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
      })();
    </script>
  

  <!-- Baidu Push -->
  
    <script>
      (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
          bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
          bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
      })();
    </script>
  

  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>

  <meta name="google-site-verification" content="lxDfCplOZbIzjhG34NuQBgu2gdyRlAtMB4utP5AgEBc"/>
  <meta name="baidu-site-verification" content="PpzM9WxOJU"/>

  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="description" content="It&#39;s an IT blog..."/>
  <meta name="keyword" content="Bin&#39;s Blog"/>
  <link rel="shortcut icon" href="/img/avatar/Bin.jpg"/>

  <!-- Place this tag in your head or just before your close body tag. -->
  <script async="async" defer="defer" src="https://buttons.github.io/buttons.js"></script>

  
    <!-- Bootstrap Core CSS -->
    <link rel="stylesheet" href="/css/bootstrap.min.css"/>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="/css/beantech.min.css"/>

    <!-- Pygments Highlight CSS -->
    <link rel="stylesheet" href="/css/highlight.css"/>
    <link rel="stylesheet" href="/css/widget.css"/>
    <link rel="stylesheet" href="/css/rocket.css"/>
    <link rel="stylesheet" href="/css/signature.css"/>
    <link rel="stylesheet" href="/css/catalog.css"/>
    <link rel="stylesheet" href="/css/livemylife.css"/>

    
      <!-- wave start -->
      <link rel="stylesheet" href="/css/wave.css"/>
      <!-- wave end -->
    

    
      <!-- top start (article top hot config) -->
      <link rel="stylesheet" href="/css/top.css"/>
      <!-- top end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/scroll.css"/>
      <!-- ThemeColor end -->
    

    
      <!-- viewer start (Picture preview) -->
      <link rel="stylesheet" href="/css/viewer.min.css"/>
      <!-- viewer end -->
    

    
      <!-- Search start -->
      <link rel="stylesheet" href="/css/search.css"/>
      <!-- Search end -->
    

    
      <!-- ThemeColor start -->
      <link rel="stylesheet" href="/css/themecolor.css"/>
      <!-- ThemeColor end -->
    

    

    
      <!-- gitalk start -->
      <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css"> -->
      <link rel="stylesheet" href="/css/gitalk.css"/>
      <!-- gitalk end -->
    
  

  <!-- Custom Fonts -->
  <!-- <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css" rel="stylesheet" type="text/css"> -->
  <!-- Hux change font-awesome CDN to qiniu -->
  <link rel="stylesheet" href="https://cdn.staticfile.org/font-awesome/4.5.0/css/font-awesome.min.css" type="text/css">
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">

  <!-- Hux Delete, sad but pending in China <link href='http://fonts.googleapis.com/css?family=Lora:400,700,400italic,700italic' rel='stylesheet' type='text/css'> <link
  href='http://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800' rel='stylesheet' type='text/ css'> -->

  <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
  <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
  <!--[if lt IE 9]> <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script> <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script> <![endif]-->

  <!-- ga & ba script hoook -->
  <link rel="canonical" href="http://yoursite-url/2021/01/27/基于Yolov4和Deepsort的智能交通场景应用/">
  <title>
    
      基于Yolov4和Deepsort的智能交通场景应用 - Bin&#39;s Blog
    
  </title>
<meta name="generator" content="Hexo 5.4.0"></head>


<!-- hack iOS CSS :active style -->

	<body ontouchstart="" class="body--light body--light">


		<!-- ThemeColor -->
		
		<!-- ThemeColor -->
<style type="text/css">
  .body--light {
    --light-mode: none;
    --dark-mode: block;
  }
  .body--dark {
    --light-mode: block;
    --dark-mode: none;
  }
  i.mdui-icon.material-icons.light-mode {
    display: var(--light-mode);
  }
  i.mdui-icon.material-icons.dark-mode {
    display: var(--dark-mode);
  }
</style>
<div class="toggle" onclick="document.body.classList.toggle('body--dark')">
  <i class="mdui-icon material-icons light-mode"></i>
  <i class="mdui-icon material-icons dark-mode"></i>
</div>
<script>
  //getCookieValue
  function getCookieValue(a) {
    var b = document.cookie.match('(^|[^;]+)\\s*' + a + '\\s*=\\s*([^;]+)');
    return b
      ? b.pop()
      : '';
  }
  let themeMode = 'light';
  if (getCookieValue('sb-color-mode') && (getCookieValue('sb-color-mode') !== themeMode)) {
    let dbody = document.body.classList;
    themeMode === 'dark' ? dbody.remove('body--dark') : dbody.add('body--dark');
  }

  //setCookieValue
  var toggleBtn = document.querySelector(".toggle");
  toggleBtn.addEventListener("click", function () {
    var e = document.body.classList.contains("body--dark");
    var cookieString = e
      ? "dark"
      : "light";
    var exp = new Date();
    exp.setTime(exp.getTime() + 3 * 24 * 60 * 60 * 1000); //3天过期
    document.cookie = "sb-color-mode=" + cookieString + ";expires=" + exp.toGMTString() + ";path=/";
  });
</script>

		

		<!-- Gitter -->
		
		<!-- Gitter -->
<!-- Docs:https://gitter.im/?utm_source=left-menu-logo -->
<script>
  ((window.gitter = {}).chat = {}).options = {
    room: 'your-community/your-room'
  };
</script>
<script src="https://sidecar.gitter.im/dist/sidecar.v1.js" async defer></script>

		

		<!-- Navigation (contains search)-->
		<!-- Navigation -->
<nav class="navbar navbar-default navbar-custom navbar-fixed-top">
  <div class="container-fluid">
    <!-- Brand and toggle get grouped for better mobile display -->
    <div class="navbar-header page-scroll">
      <button type="button" class="navbar-toggle">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="/">An Ordinary Life</a>
    </div>

    <!-- Collect the nav links, forms, and other content for toggling -->
    <!-- Known Issue, found by Hux: <nav>'s height woule be hold on by its content. so, when navbar scale out, the <nav> will cover tags. also mask any touch event of tags, unfortunately. -->
    <div id="huxblog_navbar">
      <div class="navbar-collapse">
        <ul class="nav navbar-nav navbar-right">
          <li>
            <a href="/">HOME</a>
          </li>

          
          
          <li>
            <a href="/about/">
              
              ABOUT
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/categories/">
              
              CATEGORIES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/archive/">
              
              ARCHIVES
              
              
            </a>
          </li>
          
          
          
          <li>
            <a href="/tags/">
              
              TAGS
              
              
            </a>
          </li>
          
          
          
          

          
          <li>
            <a class="popup-trigger">
              <span class="search-icon"></span>SEARCH</a>
          </li>
          

          <!-- LangSelect -->
          
        </ul>
      </div>
    </div>
    <!-- /.navbar-collapse -->
  </div>
  <!-- /.container -->
</nav>
<!-- progress -->
<div id="progress">
  <div class="line" style="width: 0%;"></div>
</div>

<script>
  // Drop Bootstarp low-performance Navbar Use customize navbar with high-quality material design animation in high-perf jank-free CSS3 implementation
  var $body = document.body;
  var $toggle = document.querySelector('.navbar-toggle');
  var $navbar = document.querySelector('#huxblog_navbar');
  var $collapse = document.querySelector('.navbar-collapse');

  $toggle.addEventListener('click', handleMagic)

  function handleMagic(e) {
    if ($navbar.className.indexOf('in') > 0) {
      // CLOSE
      $navbar.className = " ";
      // wait until animation end.
      setTimeout(function() {
        // prevent frequently toggle
        if ($navbar.className.indexOf('in') < 0) {
          $collapse.style.height = "0px"
        }
      }, 400)
    } else {
      // OPEN
      $collapse.style.height = "auto"
      $navbar.className += " in";
    }
  }
</script>


		<!-- Post Header (contains intro-header、signature、wordcount、busuanzi、waveoverlay) -->
		<!-- Modified by Yu-Hsuan Yen -->
<!-- Post Header -->

  <style type="text/css">
    .body--light {
      /* intro-header */
      --intro-header-background-image-url-home: url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: url('/img/header_img/vehicle.jpg');
      --intro-header-background-image-url-page: url('//img/header_img/vehicle.jpg');
    }
    .body--dark {
      --intro-header-background-image-url-home: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/newhome_bg.jpg');
      --intro-header-background-image-url-post: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('/img/header_img/vehicle.jpg');
      --intro-header-background-image-url-page: linear-gradient(rgba(0, 0, 0, 0.1), rgba(0, 0, 0, 0.2)), url('//img/header_img/vehicle.jpg');
    }

    header.intro-header {
       /*post*/
        background-image: var(--intro-header-background-image-url-post);
        /* background-image: url('/img/header_img/vehicle.jpg'); */
      
    }

    
  </style>





<header class="intro-header">
  <!-- Signature -->
  <div id="signature">
    <div class="container">
      <div class="row">
        <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
          
          <div class="post-heading">
            <div class="tags">
              
              <a class="tag" href="/tags/#Python" title="Python">Python</a>
              
              <a class="tag" href="/tags/#Pyqt5" title="Pyqt5">Pyqt5</a>
              
            </div>
            <h1>基于Yolov4和Deepsort的智能交通场景应用</h1>
            <h2 class="subheading">中国软件杯参赛作品</h2>
            <span class="meta">
              Posted by Mr.Li on
              2021-01-27
            </span>


            
            <!-- WordCount start -->
            <div class="blank_box"></div>
            <span class="meta">
              Estimated Reading Time <span class="post-count">7</span> Minutes
            </span>
            <div class="blank_box"></div>
            <span class="meta">
              Words <span class="post-count">2.2k</span> In Total
            </span>
            <div class="blank_box"></div>
            <!-- WordCount end -->
            
            


          </div>
          
        </div>
      </div>
    </div>
  </div>

  
  <!-- waveoverlay start -->
  <div class="preview-overlay">
    <svg class="preview-waves" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 24 150 28" preserveAspectRatio="none" shape-rendering="auto">
      <defs>
        <path id="gentle-wave" d="M-160 44c30 0 58-18 88-18s 58 18 88 18 58-18 88-18 58 18 88 18 v44h-352z"></path>
      </defs>
      <g class="preview-parallax">
        <use xlink:href="#gentle-wave" x="48" y="0" fill=var(--gentle-wave1)></use>
        <use xlink:href="#gentle-wave" x="48" y="3" fill=var(--gentle-wave2)></use>
        <use xlink:href="#gentle-wave" x="48" y="5" fill=var(--gentle-wave3)></use>
        <use xlink:href="#gentle-wave" x="48" y="7" fill=var(--gentle-wave)></use>
      </g>
    </svg>
  </div>
  <!-- waveoverlay end -->
  

</header>



		<!-- Main Content (Post contains
	Pager、
	tip、
	socialshare、
	gitalk、gitment、disqus-comment、
	Catalog、
	Sidebar、
	Featured-Tags、
	Friends Blog、
	anchorjs、
	) -->
		<!-- Modify by Yu-Hsuan Yen -->
<!-- Post Content -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-MML-AM_CHTML"></script>
<article>
  <div class="container">
    <div class="row">
      <!-- Post Container -->
      <div class="col-lg-8 col-lg-offset-1 col-md-10 col-md-offset-1 post-container">

        <blockquote>
<p>在2019年的最后一个月开始尝试接触目标识别和跟踪的知识，那时候的我甚至连pycharm都没有用过，还不知道各个框架的概念。在盲目的代码复现和学习中，时间来到了2020年的三月份，了解到了中软杯的赛题，努力开始有了一个方向，也是我第一个负责和成功完成的项目。项目获得第九届中国软件杯大赛的全国二等奖，至于比赛的各种奇奇怪怪的事情我们暂且不用过多关注，最后能取得这么一个成绩，是我非常满意的。</p>
</blockquote>
<h2 id="项目背景"><a href="#项目背景" class="headerlink" title="项目背景"></a>项目背景</h2><p>智慧交通建设是关系到我国国计民生的重要基础行业，我国政府对其发展极其重视。中共中央、国务院近两年先后颁布了《国家“物联网与智慧城市”研发计划2019年度项目申报指南》《关于进一步加快智慧城市建设的若干意见》等政策，明确提出推动大数据、信息共享和智慧社会的发展。</p>
<p>基于对公共交通路口摄像头类似视角的影像数据进行处理，采用计算机视觉的算法对各种复杂的交通场景进行检测识别。项目使用计算机视觉技术打造了提供多功能智慧交通相关的软件。</p>
<h2 id="项目简介和功能描述"><a href="#项目简介和功能描述" class="headerlink" title="项目简介和功能描述"></a>项目简介和功能描述</h2><p>本项目设计一种基于计算机视觉的智能摄像系统，运用了精确的单目标跟踪、多目标跟踪、实时目标识别、OCR技术、矩阵透视、射线法等多种技术，然后将技术整体展示，利用PYQT5开发出软件端，将数据可视化结果直接展示在用户眼前。</p>
<p>中软杯官网赛题要求：</p>
<ul>
<li>程序实现基本的机动车检测、车牌识别和至少实现一种交通场景功能。</li>
<li>该项目不仅实现了机动车检测、车牌识别，同时完成了如下交通场景功能。</li>
</ul>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/1.png" alt="1"></p>
<h2 id="关键技术"><a href="#关键技术" class="headerlink" title="关键技术"></a>关键技术</h2><h3 id="基于YOLO-v4和Deep-SORT的识别和跟踪"><a href="#基于YOLO-v4和Deep-SORT的识别和跟踪" class="headerlink" title="基于YOLO v4和Deep SORT的识别和跟踪"></a>基于YOLO v4和Deep SORT的识别和跟踪</h3><p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/2.png" alt="2"></p>
<ul>
<li><h4 id="车辆数据集单独训练"><a href="#车辆数据集单独训练" class="headerlink" title="车辆数据集单独训练"></a>车辆数据集单独训练</h4></li>
</ul>
<p>本项目采用YOLOv4网络作为目标检测算法，采用Deep SORT网络作为多目标跟踪算法。我们使用KITTI训练集自己训练车辆数据集，该训练集可以识别80个不同的物体，能超实时地识别目标的类型。</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/3.png" alt="3"></p>
<ul>
<li><h4 id="针对交通场景识别六类主流物体"><a href="#针对交通场景识别六类主流物体" class="headerlink" title="针对交通场景识别六类主流物体"></a>针对交通场景识别六类主流物体</h4><p>应用在交通路口处理，可以识别人(person)、轿车(car)、货车(truck)、公交车(bus)、摩托车(motorbike)和红绿灯(traffic light)，并且将种类和置信度(CI)展示在视频处理结果中。</p>
</li>
</ul>
<p>Yolov4基础模型和改进模型可以识别80类物体</p>
<h3 id="基于改进lPRnet和mtcnn的车牌识别"><a href="#基于改进lPRnet和mtcnn的车牌识别" class="headerlink" title="基于改进lPRnet和mtcnn的车牌识别"></a>基于改进lPRnet和mtcnn的车牌识别</h3><p>这部分的操作是周哥主攻的哈，我们使用改进 MTCNN + SPL + LPRNet 结合的针对车牌识别的神经网络。可以到达实时的效果，并且车牌识别精度有所提高。</p>
<p>经过自主改进的网络稳定性和识别能力大大增强，同时依旧维持了 LPRNet 的实时性。通过高效的动态规划对网络结果实时处理，是我们的算法兼顾可解释性和精度。在实践中，我们的车牌识别甚至可以实时对肉眼不可鉴别的目标作出准确识别。</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/4.png" alt="4"></p>
<p>倾斜视角的车牌面积较小，将车牌变成正视图的视角后，车牌面积会增大，从而增加车牌的识别率。</p>
<p>车牌校正</p>
<p>设置resizing factor：</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/5.png" alt="5"></p>
<h3 id="基于透视变化的实时目标速度检测"><a href="#基于透视变化的实时目标速度检测" class="headerlink" title="基于透视变化的实时目标速度检测"></a>基于透视变化的实时目标速度检测</h3><p>本项目利用基于透视变化的测速方法达到车辆测速目的</p>
<p>问题：摄像头存在俯角</p>
<p>将视频画面经过透视变换转换成俯视图，画面中所展示的视角和路面垂直，每像素所代表的实际物理距离保持固定不变，通过像素位移差和时间差计算目标速度。</p>
<p>具体操作方法如下：首先，我们在原视频画面选取四个点，这四个点构成视频画面所记录的真实世界中的某个矩形顶点（如斑马线方格的四个顶点）。其次，我们在二维平面中选取构成同样像素大小的矩形的四个顶点。然后，根据前后各四个顶点的坐标，我们可以计算出从原图到俯视图的透视转换矩阵。在得到透视转换矩阵后，我们就可以将原视频画面的任意一个点坐标转换成俯视图中的点坐标。例如我们在原视频画面中选取目标在第<strong>N</strong>帧的坐标为(<strong>Xn</strong>、<strong>Yn</strong>)，目标第<strong>M</strong>帧的坐标为(<strong>Xm</strong>、<strong>Ym</strong>)，那么经过透视矩阵的转换，对应点在俯视图画面中的坐标分别为为(<strong>Xn’</strong>, <strong>Yn’</strong>)和(<strong>Xm’</strong>, <strong>Ym’</strong>)。然后，我们利用俯视图中两点的坐标计算车辆速度。由于俯视图中的每像素距离代表的实际物理距离是固定不变的，我们不妨假设为<strong>W</strong>，那么很容易得到目标车辆沿道路方向行驶的实际物理距离<strong>s</strong>。然后根据帧与帧的时间间隔得到第<strong>N</strong>帧到第<strong>M</strong>帧之间的时间<strong>t</strong>(<strong>ms</strong>)。最后，由于在较短时间内目标车辆的行驶可以看作匀速直线运动，那么我们可以利用速度公式（其中<strong>fpst</strong>代表一帧的时间间隔）：</p>
<center class="half">    <img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/51.png" width="400">    </center>



<center class="half">    <img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/6.png" width="400">    </center>

<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/7.png" alt="7"></p>
<h3 id="基于射线算法违章区域车辆检测"><a href="#基于射线算法违章区域车辆检测" class="headerlink" title="基于射线算法违章区域车辆检测"></a>基于射线算法违章区域车辆检测</h3><p>我们基于Deep sort追踪的机动车违停技术：我们根据每个跟踪中心的位置，判断它是否停车和是否越线。在UI界面下手动圈选违章区域，然后通过判断跟踪中心的移动情况是否在违章停车区域，公交车道区域，来进行机动车和非机动车是否违章的判断。</p>
<p>采用了射线法判断跟踪中心点是否在划定区域内，<strong>射线法</strong>就是以判断点开始，向右（或向左）的水平方向作一射线，计算该射线与多边形每条边的交点个数，如果交点个数为奇数，则点位于多边形内，偶数则在多边形外。该算法对于复合多边形也能正确判断。</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/8.png" alt="8"></p>
<h2 id="项目成果展示"><a href="#项目成果展示" class="headerlink" title="项目成果展示"></a>项目成果展示</h2><p>软件开发时间耗时6个月，算法模型历经了三次更新升级，最终在8月初完成最终模型。</p>
<p>本项目于2020年5月收到计算机软件著作权登记证书，申请人为本次参赛的三位选手。目前已经开发出PC软件端。</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/9.png" alt="9"></p>
<p>在PYQT封装后的整个文件夹大小为2.47GB，我们设计成了直接可以在windows电脑上运行的exe程序，我换了个图标大概长这样子。</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/10.png" alt="10"></p>
<p>软件端的实测图片大概长这样：</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/11.png" alt="11"></p>
<p>我放一个我们预先录制的答辩视频在这，可能会比较直观一点趴：</p>
<div style="position: relative; padding: 30% 45%;">     
    <iframe style="         position: absolute;          width: 100%;          height: 100%;          left: 0; top: 0;" src="//player.bilibili.com/player.html?aid=971022307&bvid=BV1Qp4y1s7Xv&cid=279724597&page=1" scrolling="no" border="0" frameborder="no" framespacing="0" allowfullscreen="true">     </iframe> 
</div>



<h2 id="后记"><a href="#后记" class="headerlink" title="后记"></a>后记</h2><p>关于中软杯的最后一场答辩已经过去了4个月了，还想得起来那是一个午后，中午饭我恰了一碗泡面。线上视频的这边是我和宇浩和涛哥三个人挤在宿舍里狭小的课桌前，对面是一群坐在敞亮大厅里的企业和高校的专家。放松心情，我们顺利地完成了比赛的答辩，没有正式的服装，甚至听不清评委问题的时候，我们三还做出奇怪的姿势，靠近笔记本电脑的音响。视频两头的气氛是完全不搭调，好在我们进了决赛第二轮，保底已经是二等奖，答辩的结果已经有底，整个过程还是极为放松。</p>
<p>至于一等奖队伍确实也做了比我们更多的事，只是但从答辩过程来看，对他们的一些疑问依然存在于我们的脑海中。只是更好的结果对于我来说，也不是很重要了。这一段完整的比赛经历带给我的成长是毋庸置疑的，在收尾的时候感谢那段时间一起付出的队友们，大家都特别的给力，也感谢那段时间付出了心血的自己，没有那段熬夜的日子，应该也没有现在躺着度日的我。</p>
<p>附奖状：</p>
<p><img src="/2021/01/27/%E5%9F%BA%E4%BA%8EYolov4%E5%92%8CDeepsort%E7%9A%84%E6%99%BA%E8%83%BD%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E5%BA%94%E7%94%A8/12.png" alt="12"></p>


        <hr>
        <!-- Pager -->
        <ul class="pager">
          
          <li class="previous">
            <a href="/2021/01/27/基于改进Mobilenetv2的东北虎识别平台/" data-toggle="tooltip" data-placement="top" title="基于改进Mobilenetv2的东北虎识别平台">&larr; Previous Post</a>
          </li>
          
          
          <li class="next">
            <a href="/2021/01/27/2020全国大学生数学建模比赛B题/" data-toggle="tooltip" data-placement="top" title="2020全国大学生数学建模比赛B题">Next Post &rarr;</a>
          </li>
          
        </ul>

        
        <!-- tip start -->
        <!-- tip -->
<!-- tip start -->
<div class="tip">
  <p>
    
      If you like this blog or find it useful for you, you are welcome to comment on it. You are also welcome to share this blog, so that more people can participate in it. If the images used in the blog infringe your copyright, please contact the author to delete them. Thank you !
    
  </p>
</div>
<!-- tip end -->

        <!-- tip end -->
        

        
        <!-- Sharing Srtart -->
        <!-- Social Social Share Post -->
<!-- Docs:https://github.com/overtrue/share.js -->

<div class="social-share" data-initialized="true" data-disabled="tencent ,douban ,qzone ,linkedin ,facebook ,google ,diandian" data-wechat-qrcode-helper="" align="center">
  <ul class="list-inline text-center social-share-ul">
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-twitter">
        <i class="fa fa-twitter fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a class="social-share-icon icon-wechat">
        <i class="fa fa-weixin fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-weibo">
        <i class="fa fa-weibo fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon icon-qq">
        <i class="fa fa-qq fa-1x" aria-hidden="true"></i>
      </a>
    </li>
    <li class="social-share-li">
      <a target="_blank" class="social-share-icon" href="mailto:?subject=基于Yolov4和Deepsort的智能交通场景应用&body=Hi,I found this website and thought you might like it http://yoursite-url/2021/01/27/基于Yolov4和Deepsort的智能交通场景应用/">
        <i class="fa fa-envelope fa-1x" aria-hidden="true"></i>
      </a>
    </li>
  </ul>
</div>

<!-- css & js -->
<!-- <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/css/share.min.css"> -->
<script defer="defer" async="true" src="https://cdnjs.cloudflare.com/ajax/libs/social-share.js/1.0.16/js/social-share.min.js"></script>

        <!-- Sharing End -->
        
        <hr>

        <!-- comments start -->
        <!-- 1. gitalk comment -->

  <!-- gitalk start -->
  <!-- Docs:https://github.com/gitalk/gitalk/blob/master/readme-cn.md -->

  <div id="gitalk-container"></div>

  
    <!-- <script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.js"></script> -->
    <script src="/js/comment/gitalk.js"></script>
  

  <script>
    var gitalk = new Gitalk({
      clientID: '65682c9d7fede4bb7fc5',
      clientSecret: '6b9080be7fdcaae6ae9bbd667c4d2af5f16eb118',
      repo: 'lhb7.github.io',
      owner: 'lhb7',
      admin: 'lhb7',
      id: 'Wed Jan 27 2021 11:58:51 GMT+0800', // Ensure uniqueness and length less than 50
      distractionFreeMode: false, // Facebook-like distraction free mode
      perPage: 10,
      pagerDirection: 'last',
      createIssueManually: true,
      language: 'zh-CN',
      proxy: 'https://cors-anywhere.azm.workers.dev/https://github.com/login/oauth/access_token'
    });
    gitalk.render('gitalk-container');

    var gtFolded = () => {
      setTimeout(function () {
        let markdownBody = document.getElementsByClassName("markdown-body");
        let list = Array.from(markdownBody);
        list.forEach(item => {
          if (item.clientHeight > 250) {
            item.classList.add('gt-comment-body-folded');
            item.style.maxHeight = '250px';
            item.title = 'Click to Expand';
            item.onclick = function () {
              item.classList.remove('gt-comment-body-folded');
              item.style.maxHeight = '';
              item.title = '';
              item.onclick = null;
            };
          }
        })
      }, 800);
    }
  </script>

  <!-- gitalk end -->


<!-- 2. gitment comment -->


<!-- 3. disqus comment -->


        <!-- comments end -->
        <hr>

      </div>

      <!-- Catalog: Tabe of Content -->
      <!-- Table of Contents -->

    
      <aside id="sidebar">
        <div id="toc" class="toc-article">
        <strong class="toc-title">Contents</strong>
        
          <ol class="toc-nav"><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%A1%B9%E7%9B%AE%E8%83%8C%E6%99%AF"><span class="toc-nav-number">1.</span> <span class="toc-nav-text">项目背景</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%A1%B9%E7%9B%AE%E7%AE%80%E4%BB%8B%E5%92%8C%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0"><span class="toc-nav-number">2.</span> <span class="toc-nav-text">项目简介和功能描述</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%85%B3%E9%94%AE%E6%8A%80%E6%9C%AF"><span class="toc-nav-number">3.</span> <span class="toc-nav-text">关键技术</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8EYOLO-v4%E5%92%8CDeep-SORT%E7%9A%84%E8%AF%86%E5%88%AB%E5%92%8C%E8%B7%9F%E8%B8%AA"><span class="toc-nav-number">3.1.</span> <span class="toc-nav-text">基于YOLO v4和Deep SORT的识别和跟踪</span></a><ol class="toc-nav-child"><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E8%BD%A6%E8%BE%86%E6%95%B0%E6%8D%AE%E9%9B%86%E5%8D%95%E7%8B%AC%E8%AE%AD%E7%BB%83"><span class="toc-nav-number">3.1.1.</span> <span class="toc-nav-text">车辆数据集单独训练</span></a></li><li class="toc-nav-item toc-nav-level-4"><a class="toc-nav-link" href="#%E9%92%88%E5%AF%B9%E4%BA%A4%E9%80%9A%E5%9C%BA%E6%99%AF%E8%AF%86%E5%88%AB%E5%85%AD%E7%B1%BB%E4%B8%BB%E6%B5%81%E7%89%A9%E4%BD%93"><span class="toc-nav-number">3.1.2.</span> <span class="toc-nav-text">针对交通场景识别六类主流物体</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8E%E6%94%B9%E8%BF%9BlPRnet%E5%92%8Cmtcnn%E7%9A%84%E8%BD%A6%E7%89%8C%E8%AF%86%E5%88%AB"><span class="toc-nav-number">3.2.</span> <span class="toc-nav-text">基于改进lPRnet和mtcnn的车牌识别</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8E%E9%80%8F%E8%A7%86%E5%8F%98%E5%8C%96%E7%9A%84%E5%AE%9E%E6%97%B6%E7%9B%AE%E6%A0%87%E9%80%9F%E5%BA%A6%E6%A3%80%E6%B5%8B"><span class="toc-nav-number">3.3.</span> <span class="toc-nav-text">基于透视变化的实时目标速度检测</span></a></li><li class="toc-nav-item toc-nav-level-3"><a class="toc-nav-link" href="#%E5%9F%BA%E4%BA%8E%E5%B0%84%E7%BA%BF%E7%AE%97%E6%B3%95%E8%BF%9D%E7%AB%A0%E5%8C%BA%E5%9F%9F%E8%BD%A6%E8%BE%86%E6%A3%80%E6%B5%8B"><span class="toc-nav-number">3.4.</span> <span class="toc-nav-text">基于射线算法违章区域车辆检测</span></a></li></ol></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E9%A1%B9%E7%9B%AE%E6%88%90%E6%9E%9C%E5%B1%95%E7%A4%BA"><span class="toc-nav-number">4.</span> <span class="toc-nav-text">项目成果展示</span></a></li><li class="toc-nav-item toc-nav-level-2"><a class="toc-nav-link" href="#%E5%90%8E%E8%AE%B0"><span class="toc-nav-number">5.</span> <span class="toc-nav-text">后记</span></a></li></ol>
        
        </div>
      </aside>
    



      <!-- Sidebar Container -->
      <div class="
                col-lg-8 col-lg-offset-1
                col-md-10 col-md-offset-1
                sidebar-container">

        <!-- Featured Tags -->
        
        <section>
          <!-- no hr -->
          <h5>
            <a href="/tags/">FEATURED TAGS</a>
          </h5>
          <div class="tags">
            
            <a class="tag" href="/tags/#Python" title="Python">Python</a>
            
            <a class="tag" href="/tags/#Pyqt5" title="Pyqt5">Pyqt5</a>
            
          </div>
        </section>
        

        <!-- Friends Blog -->
        
        <hr>
        <h5>FRIENDS</h5>
        <ul class="list-inline">

          
          <li>
            <a href="https://soptq.me/" target="_blank">Soptq</a>
          </li>
          
          <li>
            <a href="http://beantech.org" target="_blank">Bean Tech</a>
          </li>
          
        </ul>
        
      </div>
    </div>
  </div>
</article>



<!-- anchorjs start -->
<!-- async load function -->
<!-- anchor-js, Doc:http://bryanbraun.github.io/anchorjs/ -->
<script type="text/javascript">
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function(e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  };
</script>
<script type="text/javascript">
  //anchor-js, Doc:http://bryanbraun.github.io/anchorjs/
  async ("https://cdn.bootcss.com/anchor-js/1.1.1/anchor.min.js", function() {
    anchors.options = {
      visible: 'hover',
      placement: 'left',
      // icon: 'ℬ'
      icon: '❡'
    };
    anchors.add().remove('.intro-header h1').remove('.subheading').remove('.sidebar-container h5');
  });
</script>
<style>
  /* place left on bigger screen */
  @media all and (min-width: 800px) {
    .anchorjs-link {
      position: absolute;
      left: -0.75em;
      font-size: 1.1em;
      margin-top: -0.1em;
    }
  }
</style>

<!-- anchorjs end -->



		<!-- Footer (contains ThemeColor、viewer) -->
		<!-- Footer -->
<footer>
  <div class="container">
    <div class="row">
      <div class="col-lg-8 col-lg-offset-2 col-md-10 col-md-offset-1">
        <ul class="list-inline text-center">
          

          
            <li>
              <a target="_blank" href="https://github.com/lhb7">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa fa-github fa-stack-1x fa-inverse"></i>
                </span>
              </a>
            </li>
          

          

          

          

          

          
            <li>
              <a target="_blank" href="https://www.zhihu.com/people/BinBin">
                <span class="fa-stack fa-lg">
                  <i class="fa fa-circle fa-stack-2x"></i>
                  <i class="fa  fa-stack-1x fa-inverse">知</i>
                </span>
              </a>
            </li>
          

          

        </ul>
        <p class="copyright text-muted">
          Copyright &copy;
          Mr.Li
          2022
          <br>
          Theme by
          <a target="_blank" rel="noopener" href="http://beantech.org">BeanTech</a>
          <span style="display: inline-block; margin: 0 5px;">
            <i class="fa fa-heart"></i>
          </span>
          re-Ported by
          <a target="_blank" rel="noopener" href="https://v-vincen.life/">Live My Life</a>
          |
          <iframe style="margin-left: 2px; margin-bottom:-5px;" frameborder="0" scrolling="0" width="91px" height="20px" src="https://ghbtns.com/github-btn.html?user=V-Vincen&repo=V-Vincen.github.io&type=star&count=true"></iframe>
        </p>
      </div>
    </div>
  </div>
</footer>

<a id="rocket" href="#top" class=""></a>


  <!-- jQuery -->
  <script type="text/javascript" src="/js/jquery.min.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script type="text/javascript" src="/js/bootstrap.min.js"></script>
  <!-- Custom Theme JavaScript -->
  <script type="text/javascript" src="/js/hux-blog.min.js"></script>
  <!-- catalog -->
  <script async="true" type="text/javascript" src="/js/catalog.js"></script>
  <!-- totop(rocket) -->
  <script async="true" type="text/javascript" src="/js/totop.js"></script>

  

  
    <!-- Scroll start -->
    <script async="async" type="text/javascript" src="/js/scroll.js"></script>
    <!-- Scroll end -->
  

  

  
    <!-- Mouseclick -->
    <script type="text/javascript" src="/js/mouseclick.js" content='The first step is as good as half over...,Laugh and grow fat...,Man proposes God disposes...,When all else is lost the future still remains...,Wasting time is robbing oneself...,Sharp tools make good work...,Cease to struggle and you cease to live...,A friend in need is a friend indeed...,Faith can move mountains...' color='#9933CC,#339933,#66CCCC,#FF99CC,#CCCCFF,#6666CC,#663399,#66CC99,#FF0033'></script>
  

  
    <!-- ribbon -->
    <script type="text/javascript" src="/js/ribbonDynamic.js"></script>
  

  






  <!-- viewer start -->
  <!-- viewer start (Picture preview) -->
  
    <script async="async" type="text/javascript" src="/js/viewer/viewer.min.js"></script>
    <script async="async" type="text/javascript" src="/js/viewer/pic-viewer.js"></script>
  

  <!-- viewer end -->


<script>
  // async load function
  function async (u, c) {
    var d = document,
      t = 'script',
      o = d.createElement(t),
      s = d.getElementsByTagName(t)[0];
    o.src = u;
    if (c) {
      o.addEventListener('load', function (e) {
        c(null, e);
      }, false);
    }
    s.parentNode.insertBefore(o, s);
  }

  // fastClick.js
  async ("https://cdn.bootcss.com/fastclick/1.0.6/fastclick.min.js", function () {
    var $nav = document.querySelector("nav");
    if ($nav)
      FastClick.attach($nav);
    }
  )
</script>

<!-- Because of the native support for backtick-style fenced code blocks right within the Markdown is landed in Github Pages, From V1.6, There is no need for Highlight.js, so Huxblog drops it officially. -
https://github.com/blog/2100-github-pages-now-faster-and-simpler-with-jekyll-3-0 - https://help.github.com/articles/creating-and-highlighting-code-blocks/ -->
<!-- <script> async ("http://cdn.bootcss.com/highlight.js/8.6/highlight.min.js", function () { hljs.initHighlightingOnLoad(); }) </script> <link href="http://cdn.bootcss.com/highlight.js/8.6/styles/github.min.css" rel="stylesheet"> -->

<!-- jquery.tagcloud.js -->
<!-- <script> // only load tagcloud.js in tag.html if ($('#tag_cloud').length !== 0) { async ("http://yoursite-url/js/jquery.tagcloud.js", function () { $.fn.tagcloud.defaults = { // size: { start: 1, end: 1, unit: 'em' }, color: {
start: '#bbbbee', end: '#0085a1' } }; $('#tag_cloud a').tagcloud(); }) } </script> -->


		<!-- Search -->
		
		<div class="popup search-popup local-search-popup">
  <span class="popup-btn-close">
    ESC
  </span>
  <div class="container">
    <div class="row">
      <!-- <div class="col-md-9 col-md-offset-1"> -->
      <div class="col-lg-9 col-lg-offset-1 col-md-10 col-md-offset-1 local-search-content">

        <div class="local-search-header clearfix">

          <div class="local-search-input-wrapper">
            <span class="search-icon">
              <i class="fa fa-search fa-lg" style="margin: 25px 10px 25px 20px;"></i>
            </span>
            <input autocomplete="off" placeholder="SEARCH..." type="text" id="local-search-input">
          </div>
        </div>
        <div id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>


  
    <script src="/js/ziploader.js"></script>
  
  <script>
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.json";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    // monitor main search box;
    var onPopupClose = function (e) {
      $('.popup').fadeOut(300);
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $('.popup').fadeIn(300);
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }
    // get search zip version
    $.get('/searchVersion.json?t=' + (+new Date()), function (res) {
      if (localStorage.getItem('searchVersion') !== res) {
        localStorage.setItem('searchVersion', res);
        initSearchJson();
      }
    });

    function initSearchJson() {
      initLoad(['/search.flv'], {
        loadOptions: {
          success: function (obj) {
            localStorage.setItem('searchJson', obj['search.json'])
          },
          error: function (e) {
            return console.log(e)
          }
        },
        returnOptions: {
          'json': TYPE_TEXT
        },
        mimeOptions: {
          'json': 'application/json'
        }
      })
    }
    // search function;
    var searchFunc = function (search_id, content_id) {
      'use strict';
      isfetched = true;
      var datas = JSON.parse(localStorage.getItem('searchJson'));
      // console.log(search_id)
      var input = document.getElementById(search_id);
      var resultContent = document.getElementById(content_id);
      var inputEventFunction = function () {
        var searchText = input.value.trim().toLowerCase();
        var keywords = searchText.split(/[\s\-]+/);
        if (keywords.length > 1) {
          keywords.push(searchText);
        }
        var resultItems = [];
        if (searchText.length > 0) {
          // perform local searching
          datas.forEach(function (data) {
            var isMatch = false;
            var hitCount = 0;
            var searchTextCount = 0;
            var title = data.title
              ? data.title.trim()
              : '';
            var titleInLowerCase = title.toLowerCase();
            var content = data.content
              ? data.content.trim().replace(/<[^>]+>/g, "")
              : '';
            var contentInLowerCase = content.toLowerCase();
            var articleUrl = decodeURIComponent(data.url);

            var date = data.date;
            var dateTime = date.replace(/T/, " ").replace(/.000Z/, "");
            var imgUrl = data.header_img;
            


            var indexOfTitle = [];
            var indexOfContent = [];
            // only match articles with not empty titles
            keywords.forEach(function (keyword) {
              function getIndexByWord(word, text, caseSensitive) {
                var wordLen = word.length;
                if (wordLen === 0) {
                  return [];
                }
                var startPosition = 0,
                  position = [],
                  index = [];
                if (!caseSensitive) {
                  text = text.toLowerCase();
                  word = word.toLowerCase();
                }
                while ((position = text.indexOf(word, startPosition)) > -1) {
                  index.push({position: position, word: word});
                  startPosition = position + wordLen;
                }
                return index;
              }
              indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
              indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
            });
            if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
              isMatch = true;
              hitCount = indexOfTitle.length + indexOfContent.length;
            }
            // show search results
            if (isMatch) {
              // sort index by position of keyword
              [indexOfTitle, indexOfContent].forEach(function (index) {
                index.sort(function (itemLeft, itemRight) {
                  if (itemRight.position !== itemLeft.position) {
                    return itemRight.position - itemLeft.position;
                  } else {
                    return itemLeft.word.length - itemRight.word.length;
                  }
                });
              });
              // merge hits into slices
              function mergeIntoSlice(text, start, end, index) {
                var item = index[index.length - 1];
                var position = item.position;
                var word = item.word;
                var hits = [];
                var searchTextCountInSlice = 0;
                while (position + word.length <= end && index.length != 0) {
                  if (word === searchText) {
                    searchTextCountInSlice++;
                  }
                  hits.push({position: position, length: word.length});
                  var wordEnd = position + word.length;
                  // move to next position of hit
                  index.pop();
                  while (index.length != 0) {
                    item = index[index.length - 1];
                    position = item.position;
                    word = item.word;
                    if (wordEnd > position) {
                      index.pop();
                    } else {
                      break;
                    }
                  }
                }
                searchTextCount += searchTextCountInSlice;
                return {hits: hits, start: start, end: end, searchTextCount: searchTextCountInSlice};
              }
              var slicesOfTitle = [];
              if (indexOfTitle.length != 0) {
                slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
              }
              var slicesOfContent = [];
              while (indexOfContent.length != 0) {
                var item = indexOfContent[indexOfContent.length - 1];
                var position = item.position;
                var word = item.word;
                // cut out 100 characters
                var start = position - 20;
                var end = position + 80;
                if (start < 0) {
                  start = 0;
                }
                if (end < position + word.length) {
                  end = position + word.length;
                }
                if (end > content.length) {
                  end = content.length;
                }
                slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
              }
              // sort slices in content by search text's count and hits' count
              slicesOfContent.sort(function (sliceLeft, sliceRight) {
                if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                  return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                  return sliceRight.hits.length - sliceLeft.hits.length;
                } else {
                  return sliceLeft.start - sliceRight.start;
                }
              });
              // select top N slices in content
              var upperBound = parseInt('1');
              if (upperBound >= 0) {
                slicesOfContent = slicesOfContent.slice(0, upperBound);
              }
              // highlight title and content
              function highlightKeyword(text, slice) {
                var result = '';
                var prevEnd = slice.start;
                slice.hits.forEach(function (hit) {
                  result += text.substring(prevEnd, hit.position);
                  var end = hit.position + hit.length;
                  result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                  prevEnd = end;
                });
                result += text.substring(prevEnd, slice.end);
                return result;
              }
              var resultItem = '';

              // if (slicesOfTitle.length != 0) {   resultItem += "<li><a target='_blank' href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>"; } else {   resultItem += "<li><a target='_blank' href='" +
              // articleUrl + "' class='search-result-title'>" + title + "</a>"; } slicesOfContent.forEach(function (slice) {   resultItem += "<a target='_blank' href='" + articleUrl + "'><p class=\"search-result\">" + highlightKeyword(content, slice) +
              // "...</p></a>"; }); resultItem += "</li>";

              if (slicesOfTitle.length != 0) {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</div><time class='search-result-date'>" + dateTime + "</time>";
              } else {
                resultItem += "<a target='_blank' href='" + articleUrl + "' class='search-result'><div class='search-result-left'><div class='search-result-title'>" + title + "</div><time class='search-result-date'>" + dateTime + "</time>";
              }
              slicesOfContent.forEach(function (slice) {
                resultItem += "<p class=\"search-result-content\">" + highlightKeyword(content, slice) + "...</p>";
              });
              resultItem += "</div><div class='search-result-right'><img class='media-image' src='" + imgUrl + "' width='64px' height='48px'></img></div></a>";

              resultItems.push({item: resultItem, searchTextCount: searchTextCount, hitCount: hitCount, id: resultItems.length});
            }
          })
        };

        if (keywords.length === 1 && keywords[0] === "") {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else if (resultItems.length === 0) {
          resultContent.innerHTML = '<div id="no-result"></div>'
        } else {
          resultItems.sort(function (resultLeft, resultRight) {
            if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
              return resultRight.searchTextCount - resultLeft.searchTextCount;
            } else if (resultLeft.hitCount !== resultRight.hitCount) {
              return resultRight.hitCount - resultLeft.hitCount;
            } else {
              return resultRight.id - resultLeft.id;
            }
          });
          var searchResultList = '<div class=\"search-result-list\">';
          resultItems.forEach(function (result) {
            searchResultList += result.item;
          })
          searchResultList += "</div>";
          resultContent.innerHTML = searchResultList;
        }
      }
      if ('auto' === 'auto') {
        input.addEventListener('input', inputEventFunction);
      } else {
        $('.search-icon').click(inputEventFunction);
        input.addEventListener('keypress', function (event) {
          if (event.keyCode === 13) {
            inputEventFunction();
          }
        });
      }
      // remove loading animation
      $('body').css('overflow', '');
      proceedsearch();
    }
    // handle and trigger popup window;
    $('.popup-trigger').click(function (e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc('local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });
    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function (e) {
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 && $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });

    document.addEventListener('mouseup', (e) => {
      var _con = document.querySelector(".local-search-content");
      if (_con) {
        if (!_con.contains(e.target)) {
          onPopupClose();
        }
      }
    });
  </script>


		
	</body>
</html>
